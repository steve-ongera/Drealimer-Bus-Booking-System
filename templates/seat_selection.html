{% extends 'base.html' %}

{% block title %}Select Seats - {{ trip.route }}{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Trip Info Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="bi bi-bus-front text-primary"></i>
                        {{ trip.route.origin.name }} <i class="bi bi-arrow-right mx-2"></i> {{ trip.route.destination.name }}
                    </h4>
                    <div class="row text-muted">
                        <div class="col-md-6">
                            <small>
                                <i class="bi bi-calendar3"></i> {{ trip.departure_time|date:"F j, Y" }} <br>
                                <i class="bi bi-clock"></i> {{ trip.departure_time|time:"H:i" }} - {{ trip.arrival_time|time:"H:i" }}
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small>
                                <i class="bi bi-building"></i> {{ trip.bus.company.name }} <br>
                                <i class="bi bi-star-fill text-warning"></i> {{ trip.bus.bus_type }} Class
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <h5 class="text-primary mb-0">Base Price: KSh {{ trip.base_price|floatformat:0 }}</h5>
                    <small class="text-muted">per seat</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Seat Layout -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-car-front"></i> Select Your Seats
                    </h5>
                </div>
                <div class="card-body p-4">
                    <!-- Seat Legend -->
                    <div class="seat-legend mb-4">
                        <div class="legend-item">
                            <div class="legend-seat available"></div>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat selected"></div>
                            <span>Selected</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat booked"></div>
                            <span>Booked</span>
                        </div>
                        {% if trip.bus.bus_type == 'VIP' or trip.bus.bus_type == 'MIXED' %}
                        <div class="legend-item">
                            <div class="legend-seat vip"></div>
                            <span>VIP (+50%)</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Bus Layout -->
                    <div class="bus-layout">
                        <!-- Driver Area -->
                        <div class="driver-area">
                            <i class="bi bi-person-fill"></i> DRIVER
                        </div>
                        
                        <!-- Door Indicator -->
                        <div class="text-center mb-3">
                            <small class="text-muted">
                                <i class="bi bi-door-open"></i> Door
                            </small>
                        </div>
                        
                        <!-- Seats Grid -->
                        <div class="seats-container" id="seats-container">
                            {% for seat in seats %}
                                <div class="seat {% if seat.is_available %}available{% else %}booked{% endif %} 
                                           {% if seat.seat_class == 'VIP' %}vip{% endif %}
                                           {% if seat.seat_type == 'WINDOW' %}window-seat{% endif %}"
                                     data-seat-id="{{ seat.id }}"
                                     data-seat-number="{{ seat.seat_number }}"
                                     data-seat-price="{{ trip.base_price|floatformat:2 }}"
                                     data-seat-multiplier="{{ seat.price_multiplier }}"
                                     data-seat-class="{{ seat.seat_class }}"
                                     data-row="{{ seat.row_number }}"
                                     data-col="{{ seat.column_number }}"
                                     style="grid-row: {{ seat.row_number }}; grid-column: {{ seat.column_number }};"
                                     {% if not seat.is_available %}disabled{% endif %}>
                                    {{ seat.seat_number }}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Seat Layout CSS -->
                        <style>
                            .seats-container {
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 8px;
                                max-width: 300px;
                                margin: 0 auto;
                                padding: 20px;
                                background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
                                border-radius: 15px;
                                border: 3px solid #6c757d;
                            }
                            
                            /* Create aisle space between columns 2 and 3 */
                            .seat[data-col="3"], .seat[data-col="4"] {
                                margin-left: 20px;
                            }
                        </style>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Booking Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-cart3"></i> Booking Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div id="selected-seats-info">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-hand-index" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">Select seats to continue</p>
                        </div>
                    </div>
                    
                    <div id="booking-details" style="display: none;">
                        <h6>Selected Seats:</h6>
                        <div id="selected-seats-list" class="mb-3"></div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span id="subtotal">KSh 0</span>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <span>Service Fee:</span>
                            <span>KSh 50</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total Amount:</span>
                            <span id="total-amount" class="text-success">KSh 50</span>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" id="proceed-btn" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-right"></i> Proceed to Book
                            </button>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i> Secure booking with M-Pesa
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seat Selection Tips -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-lightbulb text-warning"></i> Seat Selection Tips
                    </h6>
                    <ul class="list-unstyled small text-muted mb-0">
                        <li><i class="bi bi-check text-success"></i> Window seats offer great views</li>
                        <li><i class="bi bi-check text-success"></i> Front seats have more legroom</li>
                        <li><i class="bi bi-check text-success"></i> VIP seats include extra amenities</li>
                        <li><i class="bi bi-check text-success"></i> You can select up to 6 seats</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seat Reservation Modal -->
<div class="modal fade" id="reservationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Seat Selection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You have selected <span id="modal-seat-count"></span> seat(s) for a total of <span id="modal-total-price"></span>.</p>
                <p class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Your seats will be reserved for 5 minutes. Please complete your booking within this time.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-reservation">
                    Reserve Seats
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedSeats = [];
    const maxSeats = 6;
    const serviceFee = 50;
    
    // Seat click handler
    $('.seat.available').on('click', function() {
        const seatId = $(this).data('seat-id');
        const seatNumber = $(this).data('seat-number');
        const basePrice = parseFloat($(this).data('seat-price'));
        const multiplier = parseFloat($(this).data('seat-multiplier'));
        const seatClass = $(this).data('seat-class');
        const seatPrice = basePrice * multiplier;
        
        if ($(this).hasClass('selected')) {
            // Deselect seat
            $(this).removeClass('selected');
            selectedSeats = selectedSeats.filter(seat => seat.id !== seatId);
        } else {
            // Select seat
            if (selectedSeats.length >= maxSeats) {
                alert(`You can select a maximum of ${maxSeats} seats.`);
                return;
            }
            
            $(this).addClass('selected');
            selectedSeats.push({
                id: seatId,
                number: seatNumber,
                price: seatPrice,
                class: seatClass,
                element: $(this)
            });
        }
        
        updateBookingSummary();
    });
    
    function updateBookingSummary() {
        if (selectedSeats.length === 0) {
            $('#selected-seats-info').show();
            $('#booking-details').hide();
            return;
        }
        
        $('#selected-seats-info').hide();
        $('#booking-details').show();
        
        // Update selected seats list
        let seatsList = '';
        let subtotal = 0;
        
        selectedSeats.forEach(seat => {
            seatsList += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                        <i class="bi bi-car-front"></i> Seat ${seat.number}
                        ${seat.class === 'VIP' ? '<span class="badge bg-warning text-dark">VIP</span>' : ''}
                    </span>
                    <span>KSh ${seat.price.toFixed(0)}</span>
                </div>
            `;
            subtotal += seat.price;
        });
        
        $('#selected-seats-list').html(seatsList);
        $('#subtotal').text(`KSh ${subtotal.toFixed(0)}`);
        $('#total-amount').text(`KSh ${(subtotal + serviceFee).toFixed(0)}`);
    }
    
    // Proceed to booking
    $('#proceed-btn').on('click', function() {
        if (selectedSeats.length === 0) {
            alert('Please select at least one seat.');
            return;
        }
        
        $('#modal-seat-count').text(selectedSeats.length);
        $('#modal-total-price').text($('#total-amount').text());
        $('#reservationModal').modal('show');
    });
    
    // Confirm reservation
    $('#confirm-reservation').on('click', function() {
        const button = $(this);
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Reserving...');
        
        const seatIds = selectedSeats.map(seat => seat.id);
        
        $.ajax({
            url: '{% url "reserve_seats" %}',
            method: 'POST',
            data: JSON.stringify({
                trip_id: {{ trip.id }},
                seat_ids: seatIds
            }),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    $('#reservationModal').modal('hide');
                    
                    // Redirect to booking details with selected seats
                    const seatParams = seatIds.join(',');
                    window.location.href = `{% url 'booking_details' trip.id %}?seats=${seatParams}`;
                } else {
                    alert(response.message || 'Failed to reserve seats. Please try again.');
                    
                    // Mark unavailable seats
                    if (response.unavailable_seats) {
                        response.unavailable_seats.forEach(seatId => {
                            $(`.seat[data-seat-id="${seatId}"]`)
                                .removeClass('selected available')
                                .addClass('booked')
                                .prop('disabled', true);
                        });
                        
                        // Remove unavailable seats from selection
                        selectedSeats = selectedSeats.filter(seat => 
                            !response.unavailable_seats.includes(seat.id)
                        );
                        
                        updateBookingSummary();
                    }
                }
            },
            error: function() {
                alert('An error occurred. Please try again.');
            },
            complete: function() {
                button.prop('disabled', false).html('Reserve Seats');
            }
        });
    });
    
    // Auto-refresh seat availability every 30 seconds
    setInterval(function() {
        // You can implement real-time seat availability updates here
        // This would make an AJAX call to check current seat status
    }, 30000);
});
</script>
{% endblock %}